<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Run C in Browser</title>
  </head>
  <body>
    <h2>Enter Input:</h2>
    <textarea id="inputText" rows="4" cols="50">
.i 2
.o 2
.p 4
00 10
01 01
11 -1
10 1-
.e
</textarea
    ><br />
    <button onclick="onSubmit()">Submit</button>
    <button onclick="doubleString()">Double</button>
    <h3>Output:</h3>
    <pre id="outputText"></pre>

    <script src="espresso_bin/wasm_bridge.js"></script>
    <script>
      let run_espresso, allocate, free

      // Load WebAssembly
      Module.onRuntimeInitialized = function () {
        run_espresso = Module.cwrap("run_espresso", "number", ["number"])
        allocate = Module.cwrap("allocate_cpp", "number", ["number"])
        free = Module.cwrap("free_cpp", null, ["number"])
      }

      function onSubmit() {
        // Prepare input
        const input = document.getElementById("inputText").value
        console.log(input)
        console.log(input.length)
        const buffer_size = input.length + 1
        const inputPtr = allocate(buffer_size)
        Module.stringToUTF8(input, inputPtr, buffer_size)
        // Call
        const resultPtr = run_espresso(inputPtr)
        // Reading output
        const result = Module.UTF8ToString(resultPtr)
        console.log(result)
        console.log("result len:", result.length)
        document.getElementById("outputText").innerText = `Return: ${result}`
        // Cleanup
        free(inputPtr)
        free(resultPtr)
      }

      function doubleString() {
        const e = document.getElementById("inputText")
        e.value += e.value
      }
    </script>
  </body>
</html>
